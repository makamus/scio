machine:
  java:
    version: oraclejdk8
  environment:
    SBT_OPTS: "-XX:ReservedCodeCacheSize=256m -Xms1g -Xmx2g"
    JAVA_OPTS: "-Dsun.io.serialization.extendedDebugInfo=true"
    GOOGLE_APPLICATION_CREDENTIALS: "scripts/data-integration-test.json"

dependencies:
  cache_directories:
    - "~/.ivy2"
    - "~/.sbt"
  pre:
    - hostname
    - wget -q https://dl.bintray.com/sbt/debian/sbt-1.0.4.deb
    - sudo dpkg -i sbt-1.0.4.deb
    - find ~/.sbt -name "*.lock" | xargs -r rm
    - find ~/.ivy2 -name "ivydata-*.properties" | xargs -r rm
  override:
    - sbt +update

test:
  override:
    - ./scripts/circleci_test.sh:
        parallel: true
    - ./scripts/circleci_repl_it.sh:
        parallel: true
  post:
    - ./scripts/circleci_test_post.sh:
        parallel: true

deployment:
  release:
    tag: /v.*/
    commands:
      - go get -u github.com/tcnksm/ghr
      - sbt ++2.11.11 "project scio-repl" clean assembly
      - mkdir "$CIRCLE_ARTIFACTS/repl"
      - cp scio-repl/target/scala-*/scio-repl-*.jar "$CIRCLE_ARTIFACTS/repl/"
      - ghr -u spotify -draft $CIRCLE_TAG "$CIRCLE_ARTIFACTS/repl"
